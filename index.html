<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAREK Tickets - متعدد العملات</title>
    <style>
        :root {
            --primary-color: #4A00E0;
            --secondary-color: #8E2DE2;
            --accent-color: #FF416C;
            --success-color: #00D2A0;
            --warning-color: #FFA62E;
            --cancel-color: #8E44AD;
            --light-color: #F8F9FF;
            --dark-color: #1A1A2E;
            --card-bg: #FFFFFF;
            --lyd-color: #218838;
            --eur-color: #007BFF;
            --usd-color: #FF5722;
            --gradient-primary: linear-gradient(135deg, #4A00E0 0%, #8E2DE2 100%);
            --gradient-secondary: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
            --gradient-success: linear-gradient(135deg, #00D2A0 0%, #00B894 100%);
            --gradient-warning: linear-gradient(135deg, #FFA62E 0%, #FF9A3D 100%);
            --gradient-cancel: linear-gradient(135deg, #8E44AD 0%, #6C3483 100%);
            --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            --gradient-lyd: linear-gradient(135deg, #218838 0%, #28a745 100%);
            --gradient-eur: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
            --gradient-usd: linear-gradient(135deg, #FF5722 0%, #e64a19 100%);
            --shadow-light: 0 10px 30px rgba(74, 0, 224, 0.08);
            --shadow-medium: 0 15px 35px rgba(74, 0, 224, 0.12);
            --shadow-heavy: 0 20px 50px rgba(74, 0, 224, 0.15);
            --border-radius: 16px;
            --border-radius-sm: 10px;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* تصميم ليلي جديد */
        .dark-mode {
            --primary-color: #8B5CF6;
            --secondary-color: #A78BFA;
            --accent-color: #FB7185;
            --success-color: #34D399;
            --warning-color: #FBBF24;
            --cancel-color: #C084FC;
            --light-color: #1F2937;
            --dark-color: #F9FAFB;
            --card-bg: #374151;
            
            --gradient-primary: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            --gradient-secondary: linear-gradient(135deg, #FB7185 0%, #F87171 100%);
            --gradient-success: linear-gradient(135deg, #34D399 0%, #10B981 100%);
            --gradient-warning: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);
            --gradient-cancel: linear-gradient(135deg, #C084FC 0%, #A78BFA 100%);
            --gradient-dark: linear-gradient(135deg, #374151 0%, #4B5563 100%);
            
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.2);
            --shadow-medium: 0 15px 35px rgba(0, 0, 0, 0.25);
            --shadow-heavy: 0 20px 50px rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #F8F9FF 0%, #EFF2FF 100%);
            color: #333;
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            position: relative;
            overflow-x: hidden;
            transition: var(--transition);
        }
        
        .dark-mode body {
            background: linear-gradient(135deg, #111827 0%, #1F2937 100%);
            color: #E5E7EB;
        }
        
        /* زر تبديل النمط الليلي */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            color: white;
            z-index: 1000;
            box-shadow: var(--shadow-medium);
        }
        
        .theme-toggle:hover {
            transform: rotate(30deg) scale(1.1);
        }
        
        /* الترويسة المحسنة */
        .main-header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px 20px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            position: relative;
            overflow: hidden;
            border-bottom: 5px solid var(--accent-color);
            animation: slideDown 0.8s ease-out;
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 2;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-circle {
            width: 80px;
            height: 80px;
            background: var(--gradient-secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: pulse 3s infinite ease-in-out;
            transition: var(--transition);
        }
        
        .logo-circle:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 15px 35px rgba(255, 65, 108, 0.3);
        }
        
        .logo-text h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: white;
            font-weight: 800;
        }
        
        /* تبويبات جديدة بتصميم عصري */
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out 0.3s both;
        }
        
        .tab {
            flex: 1;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 700;
            color: #666;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .dark-mode .tab {
            color: #D1D5DB;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
            background-color: rgba(74, 0, 224, 0.05);
        }
        
        .dark-mode .tab.active {
            background-color: rgba(139, 92, 246, 0.1);
        }
        
        /* تصميم البطاقات الجديد */
        .modern-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            border: 1px solid rgba(74, 0, 224, 0.1);
            transition: var(--transition);
            animation: fadeIn 0.6s ease-out 0.4s both;
        }
        
        .dark-mode .modern-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modern-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-5px);
        }
        
        /* تحسينات النماذج */
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--dark-color);
            font-size: 1.1rem;
        }
        
        .dark-mode label {
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #E0E0FF;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background-color: #F8F9FF;
            color: #333;
        }
        
        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background-color: #4B5563;
            border-color: #6B7280;
            color: #E5E7EB;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(142, 45, 226, 0.2);
        }
        
        /* أزرار محسنة */
        .btn {
            display: inline-block;
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            transition: var(--transition);
            text-align: center;
            width: 100%;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(74, 0, 224, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(74, 0, 224, 0.3);
        }
        
        /* الجداول المحسنة */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(74, 0, 224, 0.1);
            max-height: 500px;
            overflow-y: auto;
            box-shadow: var(--shadow-light);
        }
        
        .dark-mode .table-container {
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        /* الشركات المحسنة */
        .company-card {
            background: linear-gradient(135deg, #F8F9FF 0%, #F0F4FF 100%);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-right: 5px solid var(--secondary-color);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }
        
        .dark-mode .company-card {
            background: linear-gradient(135deg, #374151 0%, #4B5563 100%);
        }
        
        /* الأنيميشن */
        @keyframes slideDown {
            0% { transform: translateY(-50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* تحسينات للهواتف */
        @media (max-width: 768px) {
            .main-header {
                padding: 20px 15px;
            }
            
            .logo-circle {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
            
            .logo-text h1 {
                font-size: 1.8rem;
            }
            
            .theme-toggle {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
        
        /* الطباعة */
        @media print {
            .no-print, .theme-toggle, .tabs {
                display: none !important;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- زر تبديل النمط الليلي -->
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>
    
    <!-- الترويسة -->
    <header class="main-header no-print">
        <div class="header-content">
            <div class="header-logo">
                <div class="logo-circle">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="logo-text">
                    <h1>TAREK Tickets</h1>
                    <p>متعدد العملات - الإصدار المحسن</p>
                </div>
            </div>
        </div>
    </header>
    
    <!-- تبويبات التنقل -->
    <div class="tabs no-print">
        <div class="tab active" data-tab="add">
            <i class="fas fa-plus-circle"></i> إضافة عملية
        </div>
        <div class="tab" data-tab="report">
            <i class="fas fa-chart-line"></i> كشف الحساب
        </div>
        <div class="tab" data-tab="manage">
            <i class="fas fa-cogs"></i> إدارة العمليات
        </div>
    </div>
    
    <!-- المحتوى الرئيسي -->
    <div class="container">
        <!-- تبويب إضافة عملية -->
        <div class="tab-content modern-card active" id="add-tab">
            <h2><i class="fas fa-plus-circle"></i> تسجيل عملية جديدة</h2>
            
            <!-- إدارة الشركات -->
            <button class="btn" id="open-add-company-modal">
                <i class="fas fa-plus"></i> إضافة شركة جديدة
            </button>
            
            <div class="company-list" id="company-list" style="margin-top: 20px;">
                <div class="empty-state" id="no-companies">
                    <i class="fas fa-building"></i>
                    <h3>لا توجد شركات مضافة بعد</h3>
                    <p>ابدأ بإضافة أول شركة</p>
                </div>
            </div>
            
            <div class="form-group">
                <label for="company">اختر الشركة</label>
                <select id="company">
                    <option value="">-- اختر الشركة --</option>
                </select>
            </div>
            
            <div class="company-card" style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 id="current-company">--</h3>
                        <p style="color: #666; margin-top: 5px;">الرصيد الحالي</p>
                    </div>
                    <div class="company-balance" id="company-balance" style="font-size: 1.8rem; font-weight: 800;">
                        0 دينار
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>نوع العملية</label>
                <div class="radio-group">
                    <div class="radio-option" id="ticket-option" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #F8F9FF; border-radius: var(--border-radius-sm); margin-bottom: 10px;">
                        <i class="fas fa-ticket-alt"></i>
                        <input type="radio" id="ticket" name="transaction-type" value="ticket" checked>
                        <label for="ticket" style="margin: 0; flex: 1;">تذكرة</label>
                    </div>
                    <div class="radio-option" id="fine-option" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #F8F9FF; border-radius: var(--border-radius-sm); margin-bottom: 10px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <input type="radio" id="fine" name="transaction-type" value="fine">
                        <label for="fine" style="margin: 0; flex: 1;">غرامة</label>
                    </div>
                    <div class="radio-option" id="payment-option" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #F8F9FF; border-radius: var(--border-radius-sm);">
                        <i class="fas fa-money-bill-wave"></i>
                        <input type="radio" id="payment" name="transaction-type" value="payment">
                        <label for="payment" style="margin: 0; flex: 1;">تسليم دفعة</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="currency">العملة</label>
                <select id="currency">
                    <option value="LYD">دينار ليبي (LYD)</option>
                    <option value="EUR">يورو (EUR)</option>
                    <option value="USD">دولار أمريكي (USD)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="passenger-name">اسم المسافر</label>
                <input type="text" id="passenger-name" placeholder="أدخل اسم المسافر">
            </div>
            
            <div class="form-group">
                <label for="document-number">رقم المستند</label>
                <input type="text" id="document-number" placeholder="أدخل رقم المستند">
            </div>
            
            <div class="form-group">
                <label for="amount">المبلغ</label>
                <input type="number" id="amount" placeholder="أدخل المبلغ" min="0" step="0.001">
            </div>
            
            <div class="form-group">
                <label for="date">تاريخ العملية</label>
                <input type="date" id="date" value="">
            </div>
            
            <button class="btn" id="add-transaction" style="background: var(--gradient-success);">
                <i class="fas fa-plus"></i> إضافة العملية
            </button>
            
            <button class="btn" id="reset-form" style="background: linear-gradient(135deg, #6C757D 0%, #495057 100%); margin-top: 10px;">
                <i class="fas fa-redo"></i> مسح النموذج
            </button>
        </div>
        
        <!-- تبويب كشف الحساب -->
        <div class="tab-content modern-card" id="report-tab">
            <h2><i class="fas fa-chart-line"></i> كشف الحساب</h2>
            
            <div class="form-group">
                <label for="report-company">اختر الشركة</label>
                <select id="report-company">
                    <option value="">-- اختر الشركة --</option>
                </select>
            </div>
            
            <button class="btn no-print" id="print-report" style="background: var(--gradient-dark); margin-bottom: 20px;">
                <i class="fas fa-print"></i> طباعة الكشف
            </button>
            
            <div class="table-container">
                <table id="transactions-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--gradient-dark); color: white;">
                            <th style="padding: 15px; text-align: right;">#</th>
                            <th style="padding: 15px; text-align: right;">التاريخ</th>
                            <th style="padding: 15px; text-align: right;">النوع</th>
                            <th style="padding: 15px; text-align: right;">المسافر</th>
                            <th style="padding: 15px; text-align: right;">المبلغ</th>
                            <th style="padding: 15px; text-align: right;">الرصيد</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- البيانات ستضاف هنا -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-data" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>لا توجد عمليات مسجلة</h3>
                <p>قم بإضافة عمليات جديدة باستخدام النموذج</p>
            </div>
        </div>
        
        <!-- تبويب إدارة العمليات -->
        <div class="tab-content modern-card" id="manage-tab">
            <h2><i class="fas fa-cogs"></i> إدارة العمليات</h2>
            
            <div class="filter-controls" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="filter-company">تصفية حسب الشركة</label>
                    <select id="filter-company">
                        <option value="">جميع الشركات</option>
                    </select>
                </div>
                
                <div style="flex: 1; min-width: 200px;">
                    <label for="filter-type">تصفية حسب النوع</label>
                    <select id="filter-type">
                        <option value="">جميع الأنواع</option>
                        <option value="ticket">تذكرة</option>
                        <option value="fine">غرامة</option>
                        <option value="payment">تسليم دفعة</option>
                    </select>
                </div>
                
                <button class="btn" id="reset-filters" style="background: linear-gradient(135deg, #6C757D 0%, #495057 100%); margin-top: 24px;">
                    <i class="fas fa-filter"></i> إعادة التعيين
                </button>
            </div>
            
            <div class="table-container">
                <table id="manage-transactions-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--gradient-dark); color: white;">
                            <th style="padding: 15px; text-align: right;">#</th>
                            <th style="padding: 15px; text-align: right;">التاريخ</th>
                            <th style="padding: 15px; text-align: right;">الشركة</th>
                            <th style="padding: 15px; text-align: right;">النوع</th>
                            <th style="padding: 15px; text-align: right;">المبلغ</th>
                            <th style="padding: 15px; text-align: right;">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="manage-transactions-body">
                        <!-- البيانات ستضاف هنا -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-transactions" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-exchange-alt" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>لا توجد عمليات مسجلة</h3>
                <p>قم بإضافة عمليات جديدة</p>
            </div>
        </div>
    </div>
    
    <!-- نافذة إضافة شركة جديدة -->
    <div id="add-company-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: var(--primary-color);"><i class="fas fa-building"></i> إضافة شركة جديدة</h3>
                <button class="close-modal" id="close-add-company-modal" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--accent-color);">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="new-company-name">اسم الشركة</label>
                <input type="text" id="new-company-name" placeholder="أدخل اسم الشركة">
            </div>
            
            <div class="form-group">
                <label for="initial-balance">الرصيد الافتتاحي (دينار)</label>
                <input type="number" id="initial-balance" placeholder="أدخل المبلغ" min="0" step="0.001">
                <small style="color: #666; margin-top: 5px; display: block;">القيمة الإيجابية تعني الشركة مدينة لك، والسلبية تعني أنك مدين للشركة</small>
            </div>
            
            <button class="btn" id="save-new-company" style="background: var(--gradient-success);">
                <i class="fas fa-save"></i> حفظ الشركة
            </button>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="no-print" style="text-align: center; margin-top: 40px; padding-top: 25px; border-top: 2px solid rgba(74, 0, 224, 0.1); color: #6C757D; font-size: 0.9rem; padding-bottom: 25px;">
        <p>TAREK Tickets - متعدد العملات © 2023</p>
        <p>@tro8qa | طارق الطيف للبرمجيات</p>
    </footer>

    <script>
        // البيانات الأصلية - محفوظة كما هي
        let transactions = [];
        let companies = {};
        
        // تحميل البيانات من localStorage
        function loadData() {
            const savedTransactions = localStorage.getItem('ticketSystem_transactions_multi');
            const savedCompanies = localStorage.getItem('ticketSystem_companies_multi');
            
            if (savedTransactions) {
                try {
                    transactions = JSON.parse(savedTransactions);
                } catch (e) {
                    console.error('Error loading transactions:', e);
                    transactions = [];
                }
            }
            
            if (savedCompanies) {
                try {
                    companies = JSON.parse(savedCompanies);
                } catch (e) {
                    console.error('Error loading companies:', e);
                    companies = {};
                }
            }
            
            updateUI();
        }
        
        // حفظ البيانات
        function saveData() {
            localStorage.setItem('ticketSystem_transactions_multi', JSON.stringify(transactions));
            localStorage.setItem('ticketSystem_companies_multi', JSON.stringify(companies));
        }
        
        // تحديث واجهة المستخدم
        function updateUI() {
            updateCompanySelect();
            updateReportCompanySelect();
            updateFilterCompanySelect();
            updateCompanyList();
            updateCompanyBalance();
            updateReport();
            updateManageTable();
        }
        
        // تحديث قائمة الشركات
        function updateCompanySelect() {
            const select = document.getElementById('company');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                select.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // تحديث رصيد الشركة
        function updateCompanyBalance() {
            const companySelect = document.getElementById('company');
            const company = companySelect.value;
            const balanceElement = document.getElementById('company-balance');
            const nameElement = document.getElementById('current-company');
            
            if (!company) {
                nameElement.textContent = '--';
                balanceElement.textContent = '0 دينار';
                return;
            }
            
            nameElement.textContent = company;
            
            if (!companies[company]) {
                balanceElement.textContent = '0 دينار';
                return;
            }
            
            const balances = companies[company];
            let totalBalance = (balances.LYD || 0) + (balances.EUR || 0) + (balances.USD || 0);
            
            let balanceText = '';
            if (balances.LYD) balanceText += `${formatCurrency(balances.LYD, 'LYD')} `;
            if (balances.EUR) balanceText += `${formatCurrency(balances.EUR, 'EUR')} `;
            if (balances.USD) balanceText += `${formatCurrency(balances.USD, 'USD')} `;
            
            if (balanceText === '') balanceText = '0 دينار';
            
            balanceElement.textContent = balanceText;
            
            // تحديث اللون حسب الرصيد
            if (totalBalance > 0) {
                balanceElement.style.color = 'var(--success-color)';
            } else if (totalBalance < 0) {
                balanceElement.style.color = 'var(--danger-color)';
            } else {
                balanceElement.style.color = '';
            }
        }
        
        // تحديث قائمة الشركات للعرض
        function updateCompanyList() {
            const container = document.getElementById('company-list');
            const noCompanies = document.getElementById('no-companies');
            
            if (Object.keys(companies).length === 0) {
                noCompanies.style.display = 'block';
                container.innerHTML = '<div class="empty-state" id="no-companies"><i class="fas fa-building"></i><h3>لا توجد شركات مضافة بعد</h3><p>ابدأ بإضافة أول شركة</p></div>';
                return;
            }
            
            noCompanies.style.display = 'none';
            container.innerHTML = '';
            
            Object.keys(companies).sort().forEach(company => {
                const card = document.createElement('div');
                card.className = 'company-card';
                card.style.cssText = 'padding: 20px; margin-bottom: 15px; cursor: pointer; transition: var(--transition);';
                
                const balances = companies[company];
                let totalBalance = (balances.LYD || 0) + (balances.EUR || 0) + (balances.USD || 0);
                let balanceText = '';
                
                if (balances.LYD) balanceText += `${formatCurrency(balances.LYD, 'LYD')} `;
                if (balances.EUR) balanceText += `${formatCurrency(balances.EUR, 'EUR')} `;
                if (balances.USD) balanceText += `${formatCurrency(balances.USD, 'USD')} `;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0;">${company}</h3>
                            <p style="color: #666; margin-top: 5px;">الرصيد</p>
                        </div>
                        <div style="font-size: 1.4rem; font-weight: 800; color: ${totalBalance > 0 ? 'var(--success-color)' : totalBalance < 0 ? 'var(--danger-color)' : '#666'}">
                            ${balanceText || '0 دينار'}
                        </div>
                    </div>
                    <button class="delete-company" data-company="${company}" style="background: var(--gradient-secondary); color: white; border: none; padding: 8px 16px; border-radius: var(--border-radius-sm); cursor: pointer; margin-top: 15px; width: 100%; transition: var(--transition);">
                        <i class="fas fa-trash"></i> حذف الشركة
                    </button>
                `;
                
                // اختيار الشركة عند النقر
                card.querySelector('h3').addEventListener('click', () => {
                    document.getElementById('company').value = company;
                    updateCompanyBalance();
                });
                
                // حذف الشركة
                card.querySelector('.delete-company').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCompany(company);
                });
                
                container.appendChild(card);
            });
        }
        
        // حذف شركة
        function deleteCompany(companyName) {
            if (!confirm(`هل أنت متأكد من حذف شركة "${companyName}"؟ سيتم حذف جميع عملياتها أيضاً.`)) {
                return;
            }
            
            delete companies[companyName];
            transactions = transactions.filter(t => t.company !== companyName);
            
            saveData();
            updateUI();
            showNotification('تم حذف الشركة بنجاح');
        }
        
        // إضافة شركة جديدة
        function addCompany() {
            const nameInput = document.getElementById('new-company-name');
            const balanceInput = document.getElementById('initial-balance');
            
            const name = nameInput.value.trim();
            const balance = parseFloat(balanceInput.value) || 0;
            
            if (!name) {
                alert('يرجى إدخال اسم الشركة');
                nameInput.focus();
                return;
            }
            
            if (companies[name]) {
                alert('هذه الشركة موجودة مسبقاً');
                return;
            }
            
            companies[name] = {
                LYD: balance,
                EUR: 0,
                USD: 0
            };
            
            saveData();
            updateUI();
            closeAddCompanyModal();
            showNotification('تم إضافة الشركة بنجاح');
        }
        
        // إضافة عملية جديدة
        function addTransaction() {
            const company = document.getElementById('company').value;
            const currency = document.getElementById('currency').value;
            const passengerName = document.getElementById('passenger-name').value.trim();
            const documentNumber = document.getElementById('document-number').value.trim();
            const amountInput = document.getElementById('amount');
            const dateInput = document.getElementById('date');
            
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const amount = parseFloat(amountInput.value);
            
            // التحقق من البيانات
            if (!company) {
                alert('يرجى اختيار الشركة');
                return;
            }
            
            if (!passengerName && transactionType !== 'payment') {
                alert('يرجى إدخال اسم المسافر');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('يرجى إدخال مبلغ صحيح أكبر من صفر');
                amountInput.focus();
                return;
            }
            
            if (!dateInput.value) {
                alert('يرجى اختيار تاريخ العملية');
                dateInput.focus();
                return;
            }
            
            // إنشاء العملية
            const transaction = {
                id: generateId(),
                date: dateInput.value,
                type: transactionType,
                company: company,
                amount: amount,
                currency: currency,
                passengerName: passengerName,
                documentNumber: documentNumber
            };
            
            // تحديث رصيد الشركة
            if (!companies[company]) {
                companies[company] = { LYD: 0, EUR: 0, USD: 0 };
            }
            
            if (transactionType === 'ticket' || transactionType === 'fine') {
                companies[company][currency] += amount;
            } else if (transactionType === 'payment') {
                companies[company][currency] -= amount;
            }
            
            // حفظ العملية
            transactions.push(transaction);
            saveData();
            
            // تحديث الواجهة
            updateUI();
            resetForm();
            showNotification('تم إضافة العملية بنجاح');
        }
        
        // تحديث كشف الحساب
        function updateReport() {
            const company = document.getElementById('report-company').value;
            const tbody = document.getElementById('transactions-body');
            const noData = document.getElementById('no-data');
            
            let filteredTransactions = company ? 
                transactions.filter(t => t.company === company) : 
                [...transactions];
            
            filteredTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }
            
            noData.style.display = 'none';
            tbody.innerHTML = '';
            
            let runningBalance = 0;
            
            filteredTransactions.forEach((transaction, index) => {
                if (transaction.type === 'ticket' || transaction.type === 'fine') {
                    runningBalance += transaction.amount;
                } else if (transaction.type === 'payment') {
                    runningBalance -= transaction.amount;
                }
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid rgba(74, 0, 224, 0.1)';
                
                let typeText = '';
                let typeColor = '';
                
                switch(transaction.type) {
                    case 'ticket':
                        typeText = 'تذكرة';
                        typeColor = 'var(--success-color)';
                        break;
                    case 'fine':
                        typeText = 'غرامة';
                        typeColor = 'var(--warning-color)';
                        break;
                    case 'payment':
                        typeText = 'تسليم';
                        typeColor = 'var(--primary-color)';
                        break;
                }
                
                row.innerHTML = `
                    <td style="padding: 15px;">${index + 1}</td>
                    <td style="padding: 15px;">${transaction.date}</td>
                    <td style="padding: 15px;">
                        <span style="background: ${typeColor}; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem;">
                            ${typeText}
                        </span>
                    </td>
                    <td style="padding: 15px;">${transaction.passengerName || '-'}</td>
                    <td style="padding: 15px; font-weight: bold;">
                        <span style="color: ${transaction.currency === 'LYD' ? 'var(--lyd-color)' : transaction.currency === 'EUR' ? 'var(--eur-color)' : 'var(--usd-color)'}">
                            ${formatCurrency(transaction.amount, transaction.currency)}
                        </span>
                    </td>
                    <td style="padding: 15px; font-weight: bold;">
                        <span style="color: ${runningBalance > 0 ? 'var(--success-color)' : runningBalance < 0 ? 'var(--danger-color)' : '#666'}">
                            ${formatCurrency(runningBalance, transaction.currency)}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // تحديث جدول الإدارة
        function updateManageTable() {
            const companyFilter = document.getElementById('filter-company').value;
            const typeFilter = document.getElementById('filter-type').value;
            const tbody = document.getElementById('manage-transactions-body');
            const noTransactions = document.getElementById('no-transactions');
            
            let filteredTransactions = [...transactions];
            
            if (companyFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.company === companyFilter);
            }
            
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '';
                noTransactions.style.display = 'block';
                return;
            }
            
            noTransactions.style.display = 'none';
            tbody.innerHTML = '';
            
            filteredTransactions.forEach((transaction, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid rgba(74, 0, 224, 0.1)';
                
                let typeText = '';
                let typeColor = '';
                
                switch(transaction.type) {
                    case 'ticket':
                        typeText = 'تذكرة';
                        typeColor = 'var(--success-color)';
                        break;
                    case 'fine':
                        typeText = 'غرامة';
                        typeColor = 'var(--warning-color)';
                        break;
                    case 'payment':
                        typeText = 'تسليم';
                        typeColor = 'var(--primary-color)';
                        break;
                }
                
                row.innerHTML = `
                    <td style="padding: 15px;">${index + 1}</td>
                    <td style="padding: 15px;">${transaction.date}</td>
                    <td style="padding: 15px;">${transaction.company}</td>
                    <td style="padding: 15px;">
                        <span style="background: ${typeColor}; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem;">
                            ${typeText}
                        </span>
                    </td>
                    <td style="padding: 15px; font-weight: bold;">
                        <span style="color: ${transaction.currency === 'LYD' ? 'var(--lyd-color)' : transaction.currency === 'EUR' ? 'var(--eur-color)' : 'var(--usd-color)'}">
                            ${formatCurrency(transaction.amount, transaction.currency)}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <button class="delete-transaction" data-id="${transaction.id}" style="background: var(--gradient-secondary); color: white; border: none; padding: 8px 16px; border-radius: var(--border-radius-sm); cursor: pointer; margin-left: 5px; transition: var(--transition);">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // إضافة مستمعي الأحداث للأزرار
            document.querySelectorAll('.delete-transaction').forEach(btn => {
                btn.addEventListener('click', function() {
                    const transactionId = this.getAttribute('data-id');
                    deleteTransaction(transactionId);
                });
            });
        }
        
        // حذف عملية
        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            
            if (!transaction) return;
            
            if (!confirm(`هل أنت متأكد من حذف هذه العملية؟`)) {
                return;
            }
            
            // التراجع عن تأثير العملية على رصيد الشركة
            const company = companies[transaction.company];
            if (company) {
                if (transaction.type === 'ticket' || transaction.type === 'fine') {
                    company[transaction.currency] -= transaction.amount;
                } else if (transaction.type === 'payment') {
                    company[transaction.currency] += transaction.amount;
                }
            }
            
            // حذف العملية
            transactions = transactions.filter(t => t.id !== transactionId);
            
            saveData();
            updateUI();
            showNotification('تم حذف العملية بنجاح');
        }
        
        // توليد معرف فريد
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // تنسيق العملة
        function formatCurrency(amount, currency) {
            const absAmount = Math.abs(amount);
            let symbol = '';
            let decimalDigits = 3;
            
            switch(currency) {
                case 'LYD':
                    symbol = 'دينار';
                    break;
                case 'EUR':
                    symbol = 'يورو';
                    decimalDigits = 2;
                    break;
                case 'USD':
                    symbol = 'دولار';
                    decimalDigits = 2;
                    break;
            }
            
            const formatted = new Intl.NumberFormat('ar-LY', {
                minimumFractionDigits: decimalDigits,
                maximumFractionDigits: decimalDigits
            }).format(absAmount) + ' ' + symbol;
            
            return amount < 0 ? '-' + formatted : formatted;
        }
        
        // إظهار إشعار
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--gradient-success);
                color: white;
                padding: 15px 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-heavy);
                z-index: 9999;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span style="margin-right: 10px;">${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // إضافة الأنيميشن
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // إدارة النوافذ المنبثقة
        function openAddCompanyModal() {
            document.getElementById('add-company-modal').style.display = 'flex';
            document.getElementById('new-company-name').focus();
        }
        
        function closeAddCompanyModal() {
            document.getElementById('add-company-modal').style.display = 'none';
            document.getElementById('new-company-name').value = '';
            document.getElementById('initial-balance').value = '';
        }
        
        // إعادة تعيين النموذج
        function resetForm() {
            document.getElementById('passenger-name').value = '';
            document.getElementById('document-number').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        }
        
        // تحديث قوائم الشركات
        function updateReportCompanySelect() {
            const select = document.getElementById('report-company');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- اختر الشركة --</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                select.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                select.value = currentValue;
            }
        }
        
        function updateFilterCompanySelect() {
            const select = document.getElementById('filter-company');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">جميع الشركات</option>';
            
            Object.keys(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                select.appendChild(option);
            });
            
            if (currentValue && companies.hasOwnProperty(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // الطباعة
        function preparePrint() {
            window.print();
        }
        
        // تبديل النمط الليلي
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('themeIcon');
            
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }
        
        // إعداد الأحداث
        function setupEventListeners() {
            // التبويبات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
            
            // الأحداث الرئيسية
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('open-add-company-modal').addEventListener('click', openAddCompanyModal);
            document.getElementById('close-add-company-modal').addEventListener('click', closeAddCompanyModal);
            document.getElementById('save-new-company').addEventListener('click', addCompany);
            document.getElementById('add-transaction').addEventListener('click', addTransaction);
            document.getElementById('reset-form').addEventListener('click', resetForm);
            document.getElementById('print-report').addEventListener('click', preparePrint);
            document.getElementById('reset-filters').addEventListener('click', () => {
                document.getElementById('filter-company').value = '';
                document.getElementById('filter-type').value = '';
                updateManageTable();
            });
            
            // تحديث عند تغيير القيم
            document.getElementById('company').addEventListener('change', updateCompanyBalance);
            document.getElementById('report-company').addEventListener('change', updateReport);
            document.getElementById('filter-company').addEventListener('change', updateManageTable);
            document.getElementById('filter-type').addEventListener('change', updateManageTable);
            
            // إغلاق النافذة المنبثقة عند النقر خارجها
            document.getElementById('add-company-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('add-company-modal')) {
                    closeAddCompanyModal();
                }
            });
            
            // تهيئة تاريخ اليوم
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // إغلاق بالنقر على ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAddCompanyModal();
                }
            });
        }
        
        // تهيئة التطبيق
        function initApp() {
            // تحميل النمط المحفوظ
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
            
            loadData();
            setupEventListeners();
        }
        
        // بدء التشغيل
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
